name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  code-quality:
    runs-on: ubuntu-latest
    name: Code Quality Checks
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pylint black
          pip install -r requirements.txt || true
      
      - name: Check code formatting with Black
        run: |
          echo "üé® Checking code formatting..."
          black --check --diff src/ examples/ *.py || {
            echo "‚ùå Code formatting check failed!"
            echo "Run 'black src/ examples/ *.py' to auto-format your code"
            exit 1
          }
          echo "‚úÖ Code is properly formatted"
      
      - name: Run Pylint
        run: |
          echo "üîç Running Pylint analysis..."
          pylint src/ --fail-under=9.5 --output-format=colorized --score=yes || {
            echo "‚ùå Pylint score is below 9.5"
            exit 1
          }
          echo "‚úÖ Pylint check passed"

  tests:
    runs-on: ubuntu-latest
    needs: code-quality
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.9', '3.10', '3.11']
    
    name: Tests - Python ${{ matrix.python-version }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ matrix.python-version }}-
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run tests
        run: |
          echo "üß™ Running test suite..."
          pytest tests/ -v --tb=short --cov=src --cov-report=term-missing --cov-report=xml --cov-report=html
      
      - name: Upload coverage to Codecov
        if: matrix.python-version == '3.11'
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
      
      - name: Archive test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-results-${{ matrix.python-version }}
          path: |
            htmlcov/
            coverage.xml
          retention-days: 30

  build-check:
    runs-on: ubuntu-latest
    needs: tests
    name: Build & Launch Check
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run launch tests
        run: |
          echo "üöÄ Running application launch tests..."
          pytest tests/test_launch.py -v --tb=short
          echo "‚úÖ Launch tests passed"
      
      - name: Check imports
        run: |
          echo "üì¶ Checking module imports..."
          python -c "import sys; sys.path.insert(0, 'src'); from core import config, data_buffers, sensor_parser; print('‚úÖ Core modules OK')"
          python -c "import sys; sys.path.insert(0, 'src'); from utils import battery_utils, sensor_buffers, sensor_fusion_filters; print('‚úÖ Utils modules OK')"
          python -c "import sys; sys.path.insert(0, 'src'); from actions import action_detector; print('‚úÖ Actions module OK')"
          echo "‚úÖ All modules import successfully"
      
      - name: Syntax check all Python files
        run: |
          echo "üîç Checking Python syntax..."
          find src -name "*.py" -exec python -m py_compile {} +
          find examples -name "*.py" -exec python -m py_compile {} +
          echo "‚úÖ All Python files have valid syntax"
